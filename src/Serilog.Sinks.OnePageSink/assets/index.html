<!DOCTYPE html>
<html>
<head>
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.3/css/uikit.min.css"/>

    <!-- UIkit JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.3/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.5.1/rxjs.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.3/js/uikit-icons.min.js"></script>
    <style>
        .log-list { list-style-type: none; }

        .entry { border-bottom: 1px solid #F8F8F8; }

        .entry-item { display: inline-block; }

        .entry-item__separator {
            background-color: #F8F8F8;
            width: 1px;
        }

        .hidden { display: none; }

        .fade-enter-active { transition: background-color 0.3s ease-out; }

        .fade-enter {
            background: #F9E79F;
            opacity: 0;
        }
    </style>
</head>
<body>
<div id="app">
    <log-list :events="events"></log-list>
</div>

<template id="log-list">
    <section class="events">
        <h1>Events</h1>
        <div class="log-list__checkbox">
            <input id="checkbox" type="checkbox" v-on:change="onReceiveChange" v-model="receiveMessages">
            <label for="checkbox">Receive messages</label>
        </div>
        <transition-group name="fade" tag="ul" class="log-list">
            <log-entry v-for="(entry, index) in events"
                       :entry="entry"
                       :key="entry">
            </log-entry>
        </transition-group>
    </section>
</template>

<template id="log-entry">
    <li class="entry">

        <div class="entry-item entry-item__timespan">{{ entry.timestamp.toLocaleString() }}</div>
        <div class="entry-item entry-item__separator"></div>
        <div class="entry-item entry-item__message" v-on:click="toggle">{{ entry.message }}</div>
        <div class="entry-details" v-bind:class="{ hidden: isHidden }">
            <pre>
{{entry.details}}
</pre>
        </div>
    </li>
</template>

<script src="~/lib/@aspnet/signalr/dist/browser/signalr.js"></script>
<script src="~/lib/vue/dist/vue.min.js"></script>
<script>
    const { Subject } = rxjs;
    const { bufferTime } = rxjs.operators;

    Vue.component('log-entry',
        {
            template: '#log-entry',
            props: ['entry'],
            data: function() {
                return {
                    isHidden: true
                };
            },
            methods: {
                toggle() {
                    this.isHidden = !this.isHidden;
                }
            }
        });

    Vue.component('log-list',
        {
            template: '#log-list',
            props: {
                events: { default: [] }
            },
            data() {
                return {
                    receiveMessages: true,
                    maximumItems: 50
                };
            },
            created: function() {
                var thisLogList = this;
                this.connection = new signalR.HubConnectionBuilder().withUrl("/logevents").build();
                this.subject = new Subject();
                this.subject
                    .pipe(bufferTime(500))
                    .subscribe(messages => {
                        if (messages.length === 0) {
                            return;
                        }
                        messages.map(x => {
                            return {
                                timestamp: new Date(x.logEvents.timestamp),
                                message: x.message,
                                details: x.logEvents
                            };
                        }).forEach(x => {
                            thisLogList.events.unshift(x);
                        });
                        thisLogList.events.length = Math.min(thisLogList.events.length, thisLogList.maximumItems);
                    });

            },
            mounted: function() {
                var thisLogList = this;
                this.connection.start();
                this.connection.on("LogMessage",
                    function(message, logEvents) {
                        const item = {
                            message: message,
                            logEvents: logEvents
                        };
                        thisLogList.subject.next(item);
                    });

            },
            methods: {
                onReceiveChange() {
                    if (this.receiveMessages == false) {
                        this.connection.stop();
                        return;
                    }
                    this.connection.start();
                },
                clearAll() {
                    this.events = [];
                },
            }
        });

    new Vue({
        el: '#app',
        data: {
            events: []
        }
    });


</script>
</body>
</html>